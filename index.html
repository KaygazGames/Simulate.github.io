<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Hackster.io</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
    .hidden { display: none; }
    input, button { padding: 10px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #333; color: #fff; }
    .form-container { background: #fff; padding: 15px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; }
    .message { padding: 10px; background: #e7e7e7; border-left: 5px solid #333; margin-top: 10px; }
    /* Modal Stilleri */
    #hackModal, #adminModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none;
      align-items: center; justify-content: center;
    }
    #hackModal .modal-content,
    #adminModal .modal-content {
      background: #fff; padding: 20px; border-radius: 4px; width: 300px; text-align: center;
    }
    #hackModal button, #adminModal button { margin: 10px; }
    /* Admin Panel Butonu */
    #goToAdminBtn {
      padding: 12px 20px;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
    }
  </style>
  <!-- Firebase SDK (compat sürümleri) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Senkranize Banka & Hacker Simülatörü</h1>
    <button id="logoutButton" class="hidden">Çıkış Yap</button>
  </header>

  <!-- Giriş / Kayıt Bölümü -->
  <div id="auth-section" class="form-container">
    <h2>Hesap Oluştur / Oturum Aç</h2>
    <div id="registerDiv">
      <h3>Kayıt Ol</h3>
      <input type="text" id="regUsername" placeholder="Kullanıcı Adı">
      <input type="password" id="regPassword" placeholder="Şifre">
      <button id="registerButton">Kayıt Ol</button>
    </div>
    <hr>
    <div id="loginDiv">
      <h3>Oturum Aç</h3>
      <input type="text" id="loginUsername" placeholder="Kullanıcı Adı">
      <input type="password" id="loginPassword" placeholder="Şifre">
      <button id="loginButton">Oturum Aç</button>
    </div>
    <div class="message" id="authMessage"></div>
  </div>

  <!-- Simülasyon Bölümü -->
  <div id="simulation-section" class="form-container hidden">
    <h2>Merhaba, <span id="currentUserName"></span>!</h2>
    <p>Bakiye: \$<span id="currentUserBalance"></span></p>

    <!-- Normal Kullanıcı Hack Bölümü -->
    <div id="hackSection">
      <h3>Hackle</h3>
      <p>
        İşlem ücreti 100 \$'dır. Hack moduna girdikten sonra, geri dönüşümle ilgili soruya doğru cevabı verirseniz hedef hesaptan 100 \$ çalınır; yanlış cevapta 100 \$ ceza uygulanır.
      </p>
      <div id="hackTargetArea"></div>
      <div class="message" id="simMessage"></div>
    </div>

    <!-- Herkese Açık Admin Paneli Butonu -->
    <button id="goToAdminBtn" onclick="openAdminModal()">Admin Paneline Geç</button>

    <!-- Admin Paneli: Scoreboard ve Yönetim İşlemleri -->
    <div id="adminPanel" class="form-container hidden">
      <h3>Admin Paneli</h3>
      <div id="adminScoreboard"></div>
      <div class="message" id="adminMessage"></div>
    </div>
  </div>

  <!-- Hack Modal (Özel Hack Ekranı) -->
  <div id="hackModal">
    <div class="modal-content">
      <h3>Hack Modu</h3>
      <div id="hackOptions"></div>
      <button onclick="cancelHack()">İptal</button>
    </div>
  </div>

  <!-- Admin Şifre Modalı -->
  <div id="adminModal">
    <div class="modal-content">
      <h3>Admin Panelini Açma</h3>
      <p>Lütfen admin şifresini giriniz:</p>
      <input type="password" id="adminPasswordInput" placeholder="Admin Şifresi">
      <button onclick="verifyAdminPassword()">Onayla</button>
      <button onclick="cancelAdmin()">İptal</button>
    </div>
  </div>

  <script>
    /***** Firebase Başlatma *****/
    // Kendi Firebase yapılandırma bilgilerinizi buraya ekleyin.
    const firebaseConfig = {
      apiKey: "AIzaSyD1gL06NnTrToBUyyqWC8bnjfXlohLQzYM",
      authDomain: "hackstersw.firebaseapp.com",
      projectId: "hackstersw",
      // diğer bilgileri ekleyin...
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /***** DOM Elemanları *****/
    const authSection = document.getElementById("auth-section");
    const simulationSection = document.getElementById("simulation-section");
    const authMessage = document.getElementById("authMessage");
    const simMessage = document.getElementById("simMessage");
    const currentUserNameSpan = document.getElementById("currentUserName");
    const currentUserBalanceSpan = document.getElementById("currentUserBalance");
    const usersListDiv = document.getElementById("usersList");
    const hackTargetArea = document.getElementById("hackTargetArea");
    const logoutButton = document.getElementById("logoutButton");
    const hackSection = document.getElementById("hackSection");
    const adminPanel = document.getElementById("adminPanel");
    const adminMessage = document.getElementById("adminMessage");
    const adminScoreboard = document.getElementById("adminScoreboard");
    const goToAdminBtn = document.getElementById("goToAdminBtn");

    let currentUser = null;
    let currentHackTarget = null;
    let hackCorrectCode = "";
    let adminPanelOpen = false; // Admin panel scoreboard'ın görünür olup olmadığını takip eder

    /***** Kayıt İşlemleri *****/
    document.getElementById("registerButton").addEventListener("click", async function() {
      const username = document.getElementById("regUsername").value.trim();
      const password = document.getElementById("regPassword").value.trim();
      if(!username || !password) {
        authMessage.textContent = "Lütfen tüm alanları doldurun.";
        return;
      }
      const userRef = db.collection("users").doc(username);
      const doc = await userRef.get();
      if(doc.exists) {
        authMessage.textContent = "Bu kullanıcı adı zaten alınmış.";
        return;
      }
      // Kayıt sırasında admin yetkisi tanımlanmıyor; herkes aynı.
      await userRef.set({ password: password, balance: 1000, banned: false });
      authMessage.textContent = "Kayıt başarılı! Artık oturum açabilirsiniz.";
    });

    /***** Oturum Açma İşlemleri *****/
    document.getElementById("loginButton").addEventListener("click", async function() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      const userRef = db.collection("users").doc(username);
      const doc = await userRef.get();
      if(doc.exists && doc.data().password === password) {
        if(doc.data().banned) {
          authMessage.textContent = "Bu hesap banlanmıştır.";
          return;
        }
        currentUser = { 
          username: username, 
          balance: doc.data().balance 
        };
        authMessage.textContent = "";
        switchToSimulation();
      } else {
        authMessage.textContent = "Hatalı kullanıcı adı veya şifre.";
      }
    });

    /***** Çıkış İşlemi *****/
    logoutButton.addEventListener("click", function(){
      currentUser = null;
      authSection.classList.remove("hidden");
      simulationSection.classList.add("hidden");
      logoutButton.classList.add("hidden");
      authMessage.textContent = "";
      simMessage.textContent = "";
      adminPanelOpen = false;
      adminScoreboard.classList.add("hidden");
      adminMessage.textContent = "";
    });

    /***** Simülasyon Ekranına Geçiş *****/
    function switchToSimulation() {
      authSection.classList.add("hidden");
      simulationSection.classList.remove("hidden");
      logoutButton.classList.remove("hidden");
      currentUserNameSpan.textContent = currentUser.username;
      updateCurrentUserBalance();
      subscribeToUsers();
      // Hack bölümü her kullanıcı için görünür.
      hackSection.classList.remove("hidden");
    }

    /***** Gerçek Zamanlı Senkronizasyon *****/
    function subscribeToUsers() {
      db.collection("users").onSnapshot(snapshot => {
        let users = [];
        snapshot.forEach(doc => {
          users.push({ username: doc.id, ...doc.data() });
        });
        renderUsersList(users);
        updateCurrentUserBalanceFromSnapshot(users);
        updateHackTargetArea(users);
        if(adminPanelOpen) {
          renderAdminScoreboard(users);
        }
      });
    }

    /***** Kullanıcı Listesi (Normal) *****/
    function renderUsersList(users) {
      let html = '<table><tr><th>Kullanıcı Adı</th><th>Bakiye (\$)</th><th>İşlem</th></tr>';
      users.forEach(u => {
        if(u.username !== currentUser.username) {
          html += `<tr>
                     <td>${u.username}</td>
                     <td>${u.balance}${u.banned ? " (BAN)" : ""}</td>
                     <td><button onclick="initHack('${u.username}')">Hackle (100\$)</button></td>
                   </tr>`;
        }
      });
      html += '</table>';
      usersListDiv.innerHTML = html;
    }

    /***** Admin Scoreboard ve İşlemleri *****/
    function renderAdminScoreboard(users) {
      let html = '<table><tr><th>Kullanıcı Adı</th><th>Bakiye (\$)</th><th>Durum</th><th>Ceza Ver</th><th>Banla</th></tr>';
      users.forEach(u => {
        if(u.username !== currentUser.username) {
          html += `<tr>
                     <td>${u.username}</td>
                     <td>${u.balance}</td>
                     <td>${u.banned ? "Banlandı" : "Aktif"}</td>
                     <td><button onclick="givePenalty('${u.username}')">Ceza (100\$)</button></td>
                     <td>${u.banned ? "Zaten Banlı" : `<button onclick="banUser('${u.username}')">Banla</button>`}</td>
                   </tr>`;
        }
      });
      html += '</table>';
      adminScoreboard.innerHTML = html;
    }

    /***** Hack Hedefi Seçim Alanı (Normal Kullanıcı) *****/
    function updateHackTargetArea(users = null) {
      if(!users) {
        db.collection("users").get().then(snapshot => {
          let userArr = [];
          snapshot.forEach(doc => {
            userArr.push({ username: doc.id, ...doc.data() });
          });
          renderHackTargetArea(userArr);
        });
      } else {
        renderHackTargetArea(users);
      }
    }
    function renderHackTargetArea(users) {
      let html = '<select id="targetSelect">';
      users.forEach(u => {
        if(u.username !== currentUser.username) {
          html += `<option value="${u.username}">${u.username}</option>`;
        }
      });
      html += '</select> <button onclick="initHack(document.getElementById(\'targetSelect\').value)">Hackle (100\$)</button>';
      hackTargetArea.innerHTML = html;
    }

    /***** Bakiye Güncelleme *****/
    function updateCurrentUserBalanceFromSnapshot(users) {
      const user = users.find(u => u.username === currentUser.username);
      if(user) {
        currentUser.balance = user.balance;
        currentUserBalanceSpan.textContent = user.balance;
      }
    }
    function updateCurrentUserBalance() {
      db.collection("users").doc(currentUser.username).get().then(doc => {
        if(doc.exists) {
          currentUser.balance = doc.data().balance;
          currentUserBalanceSpan.textContent = doc.data().balance;
        }
      });
    }

    /***** Hack İşlemleri (Normal Kullanıcı) *****/
    function initHack(targetUsername) {
      if(currentUser.balance < 100) {
        simMessage.textContent = "Hackleme ücreti için yetersiz bakiye!";
        return;
      }
      currentHackTarget = targetUsername;
      showHackModal();
    }
    // Hack modalunda geri dönüşüm sorusu soruluyor.
    function showHackModal() {
      const modal = document.getElementById("hackModal");
      const hackOptionsDiv = document.getElementById("hackOptions");
      const recyclingQuestion = {
        question: "Geri dönüşümün temel faydası nedir?",
        options: [
          "Kaynak tasarrufu sağlar",
          "Enerji israfı yapar",
          "Atıkları artırır",
          "Hava kirliliğini artırır"
        ],
        correct: "Kaynak tasarrufu sağlar"
      };
      hackCorrectCode = recyclingQuestion.correct;
      const options = shuffleArray(recyclingQuestion.options.slice());
      let html = `<p>${recyclingQuestion.question}</p>`;
      options.forEach(option => {
        html += `<button onclick="processHackAnswer('${option}')">${option}</button>`;
      });
      hackOptionsDiv.innerHTML = html;
      modal.style.display = "flex";
    }
    function hideHackModal() {
      document.getElementById("hackModal").style.display = "none";
    }
    function cancelHack() {
      hideHackModal();
    }
    function shuffleArray(array) {
      let currentIndex = array.length, temporaryValue, randomIndex;
      while (0 !== currentIndex) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }
      return array;
    }

    // Firestore transaction ile hack işlemi gerçekleştiriliyor.
    async function processHackAnswer(selectedCode) {
      hideHackModal();
      simMessage.textContent = "İşlem yapılıyor...";
      const hackerRef = db.collection("users").doc(currentUser.username);
      const targetRef = db.collection("users").doc(currentHackTarget);
      try {
        await db.runTransaction(async (transaction) => {
          const hackerDoc = await transaction.get(hackerRef);
          const targetDoc = await transaction.get(targetRef);
          if(!hackerDoc.exists || !targetDoc.exists) {
            throw "Kullanıcı bulunamadı!";
          }
          let hackerBalance = hackerDoc.data().balance;
          let targetBalance = targetDoc.data().balance;
          if(hackerBalance < 100) {
            throw "Yetersiz bakiye!";
          }
          // İşlem ücreti 100\$ kesiliyor.
          hackerBalance -= 100;
          if(selectedCode === hackCorrectCode) {
            const stealAmount = targetBalance >= 100 ? 100 : targetBalance;
            targetBalance -= stealAmount;
            hackerBalance += stealAmount;
            simMessage.textContent = `${currentUser.username}, ${currentHackTarget}'den ${stealAmount} \$ başarıyla çaldı!`;
          } else {
            simMessage.textContent = `${currentUser.username}, yanlış cevap. 100 \$ ceza uygulandı.`;
          }
          transaction.update(hackerRef, { balance: hackerBalance });
          transaction.update(targetRef, { balance: targetBalance });
        });
      } catch (error) {
        simMessage.textContent = "İşlem başarısız: " + error;
      }
    }

    /***** Admin Paneli İşlemleri *****/
    // "Admin Paneline Geç" butonuna tıklanınca admin şifre modalı açılır.
    function openAdminModal() {
      document.getElementById("adminModal").style.display = "flex";
    }
    function cancelAdmin() {
      document.getElementById("adminModal").style.display = "none";
    }
    function verifyAdminPassword() {
      const input = document.getElementById("adminPasswordInput").value;
      // Admin panel şifresi: "adminpass"
      if(input === "adminpass") {
        document.getElementById("adminModal").style.display = "none";
        adminMessage.textContent = "Admin paneli açıldı.";
        adminScoreboard.classList.remove("hidden");
        adminPanelOpen = true;
      } else {
        adminMessage.textContent = "Yanlış admin şifresi!";
        adminScoreboard.classList.add("hidden");
        adminPanelOpen = false;
      }
    }

    async function givePenalty(username) {
      try {
        const userRef = db.collection("users").doc(username);
        await db.runTransaction(async (transaction) => {
          const userDoc = await transaction.get(userRef);
          if (!userDoc.exists) throw "Kullanıcı bulunamadı!";
          let newBalance = userDoc.data().balance - 100;
          if(newBalance < 0) newBalance = 0;
          transaction.update(userRef, { balance: newBalance });
        });
        adminMessage.textContent = "Ceza başarıyla uygulandı.";
      } catch (error) {
        adminMessage.textContent = "Ceza uygulanamadı: " + error;
      }
    }

    async function banUser(username) {
      try {
        const userRef = db.collection("users").doc(username);
        await userRef.update({ banned: true });
        adminMessage.textContent = "Kullanıcı başarıyla banlandı.";
      } catch (error) {
        adminMessage.textContent = "Ban işlemi başarısız: " + error;
      }
    }
  </script>
</body>
</html>
