<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Hackster.io</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
    .hidden { display: none; }
    input, button { padding: 10px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #333; color: #fff; }
    .form-container { background: #fff; padding: 15px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; }
    .message { padding: 10px; background: #e7e7e7; border-left: 5px solid #333; margin-top: 10px; }
    /* Modal Stilleri */
    #hackModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none;
      align-items: center; justify-content: center;
    }
    #hackModal .modal-content {
      background: #fff; padding: 20px; border-radius: 4px; width: 300px; text-align: center;
    }
    #hackModal button { margin: 10px; }
  </style>
  <!-- Firebase SDK (compat sürümleri daha kolay entegrasyon için) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Senkranize Banka & Hacker Simülatörü</h1>
    <button id="logoutButton" class="hidden">Çıkış Yap</button>
  </header>

  <!-- Giriş / Kayıt Bölümü -->
  <div id="auth-section" class="form-container">
    <h2>Hesap Oluştur / Oturum Aç</h2>
    <div id="registerDiv">
      <h3>Kayıt Ol</h3>
      <input type="text" id="regUsername" placeholder="Kullanıcı Adı">
      <input type="password" id="regPassword" placeholder="Şifre">
      <button id="registerButton">Kayıt Ol</button>
    </div>
    <hr>
    <div id="loginDiv">
      <h3>Oturum Aç</h3>
      <input type="text" id="loginUsername" placeholder="Kullanıcı Adı">
      <input type="password" id="loginPassword" placeholder="Şifre">
      <button id="loginButton">Oturum Aç</button>
    </div>
    <div class="message" id="authMessage"></div>
  </div>

  <!-- Simülasyon Bölümü -->
  <div id="simulation-section" class="form-container hidden">
    <h2>Merhaba, <span id="currentUserName"></span>!</h2>
    <p>Bakiye: \$<span id="currentUserBalance"></span></p>

    <h3>Tüm Kullanıcılar</h3>
    <div id="usersList"></div>

    <h3>Hackle</h3>
    <p>
      İşlem ücreti 100 \$'dır. Hack moduna girdikten sonra, geri dönüşüm hakkında sorulan soruya doğru cevabı verirseniz hedef hesaptan 100 \$ çalınır, yanlış cevaba basılırsa 100 \$ ceza uygulanır.
    </p>
    <div id="hackTargetArea"></div>
    <div class="message" id="simMessage"></div>
  </div>

  <!-- Hack Modal (Özel Hack Ekranı) -->
  <div id="hackModal">
    <div class="modal-content">
      <h3>Hack Modu</h3>
      <div id="hackOptions"></div>
      <button onclick="cancelHack()">İptal</button>
    </div>
  </div>

  <script>
    /***** Firebase Başlatma *****/
    // Aşağıdaki yapılandırma bilgilerini kendi Firebase projenizden alıp ekleyin.
    const firebaseConfig = {
      apiKey: "AIzaSyD1gL06NnTrToBUyyqWC8bnjfXlohLQzYM",
      authDomain: "hackstersw.firebaseapp.com",
      projectId: "hackstersw",
      // diğer bilgileri ekleyin...
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /***** DOM Elemanları *****/
    const authSection = document.getElementById("auth-section");
    const simulationSection = document.getElementById("simulation-section");
    const authMessage = document.getElementById("authMessage");
    const simMessage = document.getElementById("simMessage");
    const currentUserNameSpan = document.getElementById("currentUserName");
    const currentUserBalanceSpan = document.getElementById("currentUserBalance");
    const usersListDiv = document.getElementById("usersList");
    const hackTargetArea = document.getElementById("hackTargetArea");
    const logoutButton = document.getElementById("logoutButton");

    let currentUser = null;
    let currentHackTarget = null;
    let hackCorrectCode = "";

    /***** Kayıt İşlemleri *****/
    document.getElementById("registerButton").addEventListener("click", async function() {
      const username = document.getElementById("regUsername").value.trim();
      const password = document.getElementById("regPassword").value.trim();
      if(!username || !password) {
        authMessage.textContent = "Lütfen tüm alanları doldurun.";
        return;
      }
      const userRef = db.collection("users").doc(username);
      const doc = await userRef.get();
      if(doc.exists) {
        authMessage.textContent = "Bu kullanıcı adı zaten alınmış.";
        return;
      }
      await userRef.set({ password: password, balance: 1000 });
      authMessage.textContent = "Kayıt başarılı! Artık oturum açabilirsiniz.";
    });

    /***** Oturum Açma İşlemleri *****/
    document.getElementById("loginButton").addEventListener("click", async function() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      const userRef = db.collection("users").doc(username);
      const doc = await userRef.get();
      if(doc.exists && doc.data().password === password) {
        currentUser = { username: username, balance: doc.data().balance };
        authMessage.textContent = "";
        switchToSimulation();
      } else {
        authMessage.textContent = "Hatalı kullanıcı adı veya şifre.";
      }
    });

    /***** Çıkış İşlemi *****/
    logoutButton.addEventListener("click", function(){
      currentUser = null;
      authSection.classList.remove("hidden");
      simulationSection.classList.add("hidden");
      logoutButton.classList.add("hidden");
      authMessage.textContent = "";
      simMessage.textContent = "";
    });

    /***** Simülasyon Ekranına Geçiş *****/
    function switchToSimulation() {
      authSection.classList.add("hidden");
      simulationSection.classList.remove("hidden");
      logoutButton.classList.remove("hidden");
      currentUserNameSpan.textContent = currentUser.username;
      updateCurrentUserBalance();
      subscribeToUsers();
      updateHackTargetArea();
    }

    /***** Gerçek Zamanlı Senkronizasyon *****/
    function subscribeToUsers() {
      db.collection("users").onSnapshot(snapshot => {
        let users = [];
        snapshot.forEach(doc => {
          users.push({ username: doc.id, ...doc.data() });
        });
        renderUsersList(users);
        updateCurrentUserBalanceFromSnapshot(users);
        updateHackTargetArea(users);
      });
    }

    /***** Kullanıcı Listesi Güncelleme *****/
    function renderUsersList(users) {
      let html = '<table><tr><th>Kullanıcı Adı</th><th>Bakiye (\$)</th><th>İşlem</th></tr>';
      users.forEach(u => {
        if(u.username !== currentUser.username) {
          html += `<tr>
                     <td>${u.username}</td>
                     <td>${u.balance}</td>
                     <td><button onclick="initHack('${u.username}')">Hackle (100\$)</button></td>
                   </tr>`;
        }
      });
      html += '</table>';
      usersListDiv.innerHTML = html;
    }

    /***** Hack Hedefi Seçim Alanı *****/
    function updateHackTargetArea(users = null) {
      if(!users) {
        db.collection("users").get().then(snapshot => {
          let userArr = [];
          snapshot.forEach(doc => {
            userArr.push({ username: doc.id, ...doc.data() });
          });
          renderHackTargetArea(userArr);
        });
      } else {
        renderHackTargetArea(users);
      }
    }
    function renderHackTargetArea(users) {
      let html = '<select id="targetSelect">';
      users.forEach(u => {
        if(u.username !== currentUser.username) {
          html += `<option value="${u.username}">${u.username}</option>`;
        }
      });
      html += '</select> <button onclick="initHack(document.getElementById(\'targetSelect\').value)">Hackle (100\$)</button>';
      hackTargetArea.innerHTML = html;
    }

    /***** Bakiye Güncelleme *****/
    function updateCurrentUserBalanceFromSnapshot(users) {
      const user = users.find(u => u.username === currentUser.username);
      if(user) {
        currentUser.balance = user.balance;
        currentUserBalanceSpan.textContent = user.balance;
      }
    }
    function updateCurrentUserBalance() {
      db.collection("users").doc(currentUser.username).get().then(doc => {
        if(doc.exists) {
          currentUser.balance = doc.data().balance;
          currentUserBalanceSpan.textContent = doc.data().balance;
        }
      });
    }

    /***** Hack İşlemleri *****/
    // Hack girişiminde, işlem ücreti kontrolü yapıldıktan sonra özel hack ekranı (modal) açılır.
    function initHack(targetUsername) {
      if(currentUser.balance < 100) {
        simMessage.textContent = "Hackleme ücreti için yetersiz bakiye!";
        return;
      }
      currentHackTarget = targetUsername;
      showHackModal();
    }
    // Hack modalunda artık geri dönüşümle ilgili soru soruluyor.
    function showHackModal() {
      const modal = document.getElementById("hackModal");
      const hackOptionsDiv = document.getElementById("hackOptions");
      // Geri dönüşüm sorusu tanımı
      const recyclingQuestion = {
        question: "Geri dönüşümün temel faydası nedir?",
        options: [
          "Kaynak tasarrufu sağlar",
          "Enerji israfı yapar",
          "Atıkları artırır",
          "Hava kirliliğini artırır"
        ],
        correct: "Kaynak tasarrufu sağlar"
      };
      // Doğru cevabı global değişkene ata
      hackCorrectCode = recyclingQuestion.correct;
      // Seçenekleri karıştır
      const options = shuffleArray(recyclingQuestion.options.slice());
      let html = `<p>${recyclingQuestion.question}</p>`;
      options.forEach(option => {
        html += `<button onclick="processHackAnswer('${option}')">${option}</button>`;
      });
      hackOptionsDiv.innerHTML = html;
      modal.style.display = "flex";
    }
    function hideHackModal() {
      document.getElementById("hackModal").style.display = "none";
    }
    function cancelHack() {
      hideHackModal();
    }
    function shuffleArray(array) {
      let currentIndex = array.length, temporaryValue, randomIndex;
      while (0 !== currentIndex) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }
      return array;
    }

    // İşlem sırasında Firestore transaction kullanarak, hacker ve hedef hesapları güncelliyoruz.
    async function processHackAnswer(selectedCode) {
      hideHackModal();
      simMessage.textContent = "İşlem yapılıyor...";
      const hackerRef = db.collection("users").doc(currentUser.username);
      const targetRef = db.collection("users").doc(currentHackTarget);
      try {
        await db.runTransaction(async (transaction) => {
          const hackerDoc = await transaction.get(hackerRef);
          const targetDoc = await transaction.get(targetRef);
          if(!hackerDoc.exists || !targetDoc.exists) {
            throw "Kullanıcı bulunamadı!";
          }
          let hackerBalance = hackerDoc.data().balance;
          let targetBalance = targetDoc.data().balance;
          if(hackerBalance < 100) {
            throw "Yetersiz bakiye!";
          }
          // İşlem ücreti 100$ kesiliyor.
          hackerBalance -= 100;
          if(selectedCode === hackCorrectCode) {
            // Doğru cevap: hedef hesaptan 100$ çalınıyor (yeterli bakiye varsa)
            const stealAmount = targetBalance >= 100 ? 100 : targetBalance;
            targetBalance -= stealAmount;
            hackerBalance += stealAmount;
            simMessage.textContent = `${currentUser.username}, ${currentHackTarget}'den ${stealAmount} \$ başarıyla çaldı!`;
          } else {
            simMessage.textContent = `${currentUser.username}, yanlış cevap. 100 \$ ceza uygulandı.`;
          }
          transaction.update(hackerRef, { balance: hackerBalance });
          transaction.update(targetRef, { balance: targetBalance });
        });
      } catch (error) {
        simMessage.textContent = "İşlem başarısız: " + error;
      }
    }
  </script>
</body>
</html>
